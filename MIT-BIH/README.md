# 基于传统信号处理的房颤（AF）检测算法文档（交叉验证版）

本文档详细阐述了一种基于传统信号处理与机器学习评估框架的房颤（AF）检测算法。该算法首先通过精确的QRS波检测来计算心率变异特征，然后利用数据驱动的方式寻找最优分类阈值，并通过交叉验证来科学地评估其性能。

## 1. 背景知识

### 1.1 心电图（ECG）与房颤（AF）

- **ECG 信号**：心电图（ECG）是记录心脏在每个心动周期中电活动变化的曲线图。一个完整的心跳波形通常包含 **P波**、**QRS波群** 和 **T波**。
  - **P 波**：代表心房的去极化（收缩）。
  - **QRS 波群**：代表心室的去极化（收缩），其中 **R波** 是最显著、最高的波峰。
  - **T 波**：代表心室的复极化（舒张）。
- **房颤（Atrial Fibrillation, AF）**：房颤是最常见的心律失常之一。其主要特征是心房电活动紊乱，导致心室收缩变得极不规律。这种不规律性直接体现在心电图上，表现为 **RR间期（相邻R波顶点之间的时间间隔）的显著变化**。
- **检测策略**: 因此，精确地定位R波，并基于RR间期序列的不规则性进行分析，是检测房颤的核心思路。

![ECG Waveform](md_images/v2-24390a7879936f0501588a0c5fcf250f_b.webp)

## 2. 实现原理

算法的核心是“**预处理 -> QRS检测 -> 特征计算**”的流水线。

### 2.1 数据预处理

原始的ECG信号常常受到噪声干扰，如基线漂移（呼吸导致）和工频干扰（电力线导致）。为了确保后续R波检测的准确性，必须进行滤波。
1.  **带通滤波**：`af_detect_segment.py` 中的 `_bandpass` 函数实现了一个3阶巴特沃斯（Butterworth）带通滤波器，通带频率设置为 **5-45Hz**。
    - **目的**: 该频率范围保留了QRS波群的主要能量，同时有效滤除了低频的基线漂移、P波和T波，以及高频的肌肉噪声。
2.  **标准化（可选）**: 在一些版本中，可能会使用Z-score标准化 `(data - mean) / std`，以消除不同信号段之间振幅差异的影响，使得阈值判断更为鲁棒。

### 2.2 QRS波检测 (Pan-Tompkins 算法思想与自适应阈值)

准确的R波定位是整个算法的基石。本算法采用的是简化但高效的Pan-Tompkins算法思想。

1.  **差分操作**：
    - **原理**: R波是QRS波群中最陡峭的部分，其斜率远大于P波和T波。通过计算信号的一阶差分（`diff = sig[i+1] - sig[i-1]`），可以极大地增强R波的尖锐特征，同时抑制其他波形。
    - **代码**: `diff = np.r_[0, 0, sig[2:] - sig[:-2]]`

2.  **自适应阈值判定 (Adaptive Thresholding)**：
    - **挑战**: 由于不同患者、不同导联的ECG信号振幅差异巨大，使用一个固定的绝对阈值来检测R波是不可靠的。
    - **解决方案**: `_detect_qrs` 函数采用了一种**自适应阈值**策略，该阈值根据当前信号段自身的统计特性动态生成。
    - **代码分析**: `threshold = max(DDpos * 1.2, np.percentile(np.abs(sig), 75) * 0.4)`
        - `DDpos`：首先，代码只考虑差分信号中的**正值**（`diff[diff > 0]`），并计算其 **75百分位数** (`np.percentile(positive_diff, 75)`)。这代表了当前信号段中较高斜率的普遍水平。将其乘以一个系数（如1.2）作为主阈值。这种方法能很好地适应信号的振幅变化。
        - `np.percentile(np.abs(sig), 75) * 0.4`：这部分是备用阈值，基于原始信号的振幅。当差分信号非常弱时（例如，在一段非常平坦的信号中），它可以提供一个基础的检测门槛，防止阈值过低。
        - `max(...)`：取两者中的较大值，确保阈值既能适应信号变化，又不会低到一个会产生大量伪峰的水平。

3.  **峰值检测与不应期**：
    - **峰值搜索**: 在差分信号上，使用 `scipy.signal.find_peaks` 函数寻找所有超过上述**自适应阈值**的峰值。
    - **消除多重检测（不应期）**: 心脏在一次收缩后，需要约200毫秒的时间进行复极化，期间无法再次收缩。这个时期被称为“不应期”。代码通过设置 `find_peaks` 的 `distance` 参数（`distance=0.2*fs`，即200ms）来强制要求检测到的两个R波之间必须有最小的时间间隔，有效避免了将T波或噪声尖峰误判为额外的R波。

#### 2.2.1 补充理论：完整的Pan-Tompkins策略
尽管本项目的脚本为了效率采用的是简化版实现，但一个完整的Pan-Tompkins检测器还包含更复杂的逻辑以确保鲁棒性，主要包括：

- **搜索回溯 (Missed R-peak Detection)**
  - **原理**: 如果在预期的时间窗口内（例如，`1.66 * 平均RR间期`）没有检测到新的R波，算法会认为可能发生了漏检。
  - **策略**: 此时，算法会降低检测阈值，在上述时间段内重新搜索信号的最高峰，并将其判定为被遗漏的R波。
  - **目的**: 提升算法的**召回率**，防止因R波振幅过低或噪声干扰导致的漏检。

- **T波判别 (T-wave Discrimination)**
  - **挑战**: T波有时也会有较高的振幅和斜率，可能被误判为R波，特别是在心率较快时。
  - **策略**: 如果一个检测到的峰值紧跟在前一个R波之后（例如，在 `0.36 * 平均RR间期` 内），算法会怀疑它可能是一个T波。此时，可以通过比较该峰值的**斜率**与前一个R波的平均斜率。如果当前峰值的斜率显著低于R波的斜率（如低于50%），则判定它为T波并舍弃。
  - **目的**: 提升算法的**精确率**，避免将T波误判为QRS波。

### 2.3 RR间期特征计算

在定位所有R波峰值（`r_peaks`）后，我们计算两个核心特征来量化心率的不规则性。

1.  **RR 间期序列 (RR Interval)**:
    - `rr = np.diff(r_peaks) / FS`
    - 即相邻R波峰值索引的差值除以采样率 `FS` (400 Hz)，得到以秒为单位的时间间隔序列。

2.  **特征统计**:
    - **CV (变异系数, Coefficient of Variation)**:
        - `cv = np.std(rr) / np.mean(rr)`
        - **深层含义**: CV是一个归一化的统计量，用于衡量RR间期序列的**整体离散程度**。它反映的是心率在**一段时间内的宏观稳定性**。
        - **临床表现**: 在正常窦性心律下，心跳虽然有细微变化（心率变异性），但总体上是稳定的，因此CV值较低。而在房颤时，心室收缩完全无序，导致RR间期长短跨度极大，标准差 `np.std(rr)` 相对均值 `np.mean(rr)` 而言变得非常大，因此CV值会显著升高。

    - **ARI (相邻RR差分比, Adjacent RR Interval Ratio)**:
        - `ari = np.sum(np.abs(np.diff(rr))) / np.sum(rr)`
        - **深层含义**: ARI关注的是**心跳节律的微观变化**，即**相邻心跳之间的时间间隔变化有多剧烈**。分子 `np.sum(np.abs(np.diff(rr)))` 累加了每一次心跳到下一次心跳的“突变”幅度。
        - **临床表现**: 正常心律的RR间期变化是相对平滑的，因此相邻差值很小，ARI值较低。房颤时，RR间期可能从0.5秒突然跳到1.2秒，再跳回0.6秒，这种剧烈的、逐拍（beat-to-beat）的变化会导致相邻RR间期的差值绝对值 `np.abs(np.diff(rr))` 非常大，从而使ARI值显著升高。

    - **组合决策**: `flag = (cv > CV_TH) and (ari > ARI_TH)`。同时使用CV和ARI两个特征，可以更鲁棒地进行判断。CV从宏观上确认心率不稳定，而ARI从微观上确认节律的混乱无序，两者结合可以有效区分房颤与其他类型的心律不齐。

## 3. 代码逻辑与科学评估框架

`af_detect_segment.py` 的核心价值在于它从一个简单的检测工具，演变成了一个严谨的机器学习评估框架。它不再依赖固定的经验阈值，而是通过科学的方法来寻找最优阈值并评估算法的真实性能。

### 3.1 核心架构转变

1.  **科学评估**: 引入 **5折交叉验证** (`KFold`)，将数据集多次分割进行训练和验证，得出的性能指标（准确率）更可靠，避免了单次划分数据集带来的偶然性。
2.  **数据驱动的阈值寻优**: 摒弃固定的经验阈值（如 `CV_TH=0.07`），通过在数据上进行**网格搜索** (`Grid Search`)，自动找出最适合当前数据集的 `CV` 和 `ARI` 阈值组合。

### 3.2 工作流程详解

1.  **数据加载与准备**:
    - 加载数据，并选取1000个样本（500 AF + 500 Normal）。
    - **关键**: 将数据和标签**一同随机打乱** (`np.random.shuffle`)。这确保了后续交叉验证时，每个“折”中的数据都是随机混合的，保证了评估的公正性。

2.  **特征预计算 (效率优化)**:
    - **操作**: 在进入交叉验证循环之前，使用 `joblib.Parallel` **一次性地、并行地**为所有样本计算出 `(CV, ARI)` 特征对。
    - **目的**: 这是一个关键的性能优化。特征提取是计算密集型操作。通过预先计算所有特征，后续的阈值寻优过程只需反复比较这些数值，无需重复进行信号处理，极大提升了运行效率。

3.  **5折交叉验证 (`KFold`)**:
    - 将1000个样本的索引分成5组（每组200个）。循环5次，每次循环中，轮流将1组作为**验证集**（200个样本），其余4组作为**训练集**（800个样本）。

4.  **循环内部流程 (训练与验证)**:
    - **A. 训练阶段：在训练集上寻找最优阈值**
        1.  调用 `find_optimal_thresholds` 函数，在800个训练样本上执行**网格搜索**。
        2.  **原理**: 遍历一个预定义的 `CV` 阈值范围（如 0.02-0.20）和 `ARI` 阈值范围（如 0.10-0.40）。对每一个可能的 `(CV_TH, ARI_TH)` 组合，在训练集上进行预测，并计算 **F1-Score**。
        3.  **F1-Score**: 该指标能同时平衡“不误判”和“不漏判”两种情况，是寻找最佳分类阈值的理想选择。
        4.  **确定最佳阈值**: 网格搜索会返回在训练集上获得**最高F1-Score**的那一对 `(CV_TH, ARI_TH)`，作为当前“折”的最佳阈值。

    - **B. 验证阶段：在验证集上评估性能**
        1.  使用**刚刚在训练集上找到的最佳阈值**，对200个独立的验证集样本进行预测。
        2.  计算预测结果的**准确率** (`accuracy_score`)。这个准确率反映了模型在未知数据上的泛化能力。

5.  **汇总结果**:
    - 5次循环结束后，得到5个验证准确率。计算它们的**平均值**作为算法最终的性能评估。这个平均准确率是对算法在当前数据集上表现的一个非常可靠和稳健的度量。

## 4. 总结

该项目实现了一个完整且科学的房颤检测流程。其核心思想是：**通过鲁棒的信号处理技术（带通滤波、差分、自适应阈值）精确提取R波，计算能够反映心律不规则性的核心特征（CV 和 ARI），最终利用严谨的机器学习评估框架（交叉验证和网g格搜索）来客观、自动地确定分类边界并评估算法性能。**

这种方法不仅继承了传统算法可解释性强的优点，还通过数据驱动的优化策略，摒弃了对“经验阈值”的依赖，使得模型更加科学、稳健和高效。
